name: macOS NTP Debug
on:
  pull_request:

jobs:
  macos-ntp-debug:
    name: macOS NTP Diagnostics
    runs-on: macos-latest
    timeout-minutes: 15
    steps:
      - name: Deps
        run: |
          pip install ntplib

      - name: Test NTP with Python
        run: |
          python - <<EOF
          import ntplib
          from datetime import datetime
          
          server = '185.251.115.30'
          print(f"Testing NTP connectivity to {server}")
          
          def test_ntp(version):
              try:
                  c = ntplib.NTPClient()
                  response = c.request(server, version=version, timeout=5)
                  print(f"\nNTP v{version} Success:")
                  print(f"Time: {datetime.fromtimestamp(response.tx_time)}")
                  print(f"Stratum: {response.stratum}")
                  print(f"Offset: {response.offset:.6f} sec")
                  return True
              except Exception as e:
                  print(f"\nNTP v{version} Failed: {type(e).__name__}: {e}")
                  return False
          
          v3_success = test_ntp(3)
          v4_success = test_ntp(4)
          
          if not v3_success and not v4_success:
              print("\n::warning::All NTP requests failed - UDP/123 may be blocked")
          EOF
