name: Packaging

on:
  #  push:
  #    tags:
  #      - 'v*.*.*'
  #    branches:
  #      - master
  pull_request:

jobs:
  package:
    name: '${{ matrix.platform.os }}-${{ matrix.platform.cpu }}'
    strategy:
      fail-fast: false
      matrix:
        platform:
          - os: linux
            cpu: amd64
          #          - os: linux
          #            cpu: i386
          - os: macos
            cpu: amd64
          - os: windows
            cpu: amd64
        include:
          - platform:
              os: linux
            builder: ubuntu-22.04
            shell: bash
          - platform:
              os: macos
            builder: macos-13
            shell: bash
          - platform:
              os: windows
            builder: windows-2022
            shell: msys2 {0}
    runs-on:
      ${{ matrix.builder }}
    defaults:
      run:
        shell: ${{ matrix.shell }}
    steps:
      - uses: actions-rs/toolchain@v1
        name: Install Rust toolchain
        with:
          toolchain: stable

      - name: Checkout
        uses: actions/checkout@v3

      - name: Enable packaging on build
        run: |
          echo "BUILD_PACKAGE=true" >> $GITHUB_ENV

      - uses: actions-rs/cargo@v1
        with:
          command: build

      - name: Print Target
        uses: jaywcjlove/github-action-folder-tree@main
        with:
          exclude: ".fingerprint|build|deps|incremental"
          path: ./target/
          depth: 1

      - name: Print Debug
        uses: jaywcjlove/github-action-folder-tree@main
        with:
          exclude: ".fingerprint|build|deps|incremental"
          path: ./target/debug/
          depth: 4

      - name: Print Release
        uses: jaywcjlove/github-action-folder-tree@main
        with:
          exclude: ".fingerprint|build|deps|incremental"
          path: ./target/release/
          depth: 4

#      - name: Export artifacts
#        uses: actions/upload-artifact@v2
#        with:
#          name: ${{ runner.os }}-${{ matrix.platform.cpu }}-${{ matrix.builder }}
