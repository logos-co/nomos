name: Packaging

on:
  #  push:
  #    tags:
  #      - 'v*.*.*'
  #    branches:
  #      - master
  pull_request:

jobs:
  package:
    name: 'Packaging on ${{ matrix.platform.os }}-${{ matrix.platform.cpu }}'
    strategy:
      fail-fast: false
      matrix:
        platform:
          - os: linux
            cpu: amd64
          #          - os: linux
          #            cpu: i386
          - os: macos
            cpu: amd64
          - os: windows
            cpu: amd64
        include:
          - platform:
              os: linux
            builder: ubuntu-22.04
          - platform:
              os: macos
            builder: macos-13
          - platform:
              os: windows
            builder: windows-2022
    runs-on:
      ${{ matrix.builder }}
    steps:
      - uses: actions-rs/toolchain@v1
        name: Install Rust toolchain
        with:
          profile: minimal
          toolchain: stable
          override: true

      - uses: cargo-bins/cargo-binstall@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install risc0
        run: cargo binstall -y cargo-risczero && cargo risczero install
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout
        uses: actions/checkout@v3

      - name: Enable packaging on build (unix)
        if: matrix.platform.os == 'linux' || matrix.platform.os == 'macos'
        run: |
          echo "BUILD_PACKAGE=true" >> $GITHUB_ENV

      - name: Enable packaging on build (windows)
        if: matrix.platform.os == 'windows'
        run: |
          echo "BUILD_PACKAGE=true" | Out-File -FilePath $env:GITHUB_ENV -Append

      - uses: actions-rs/cargo@v1
        with:
          command: build

      - name: Print Target
        uses: jaywcjlove/github-action-folder-tree@main
        with:
          exclude: ".fingerprint|build|deps|incremental"
          path: ./target/
          depth: 1

      - name: Print Debug
        uses: jaywcjlove/github-action-folder-tree@main
        with:
          exclude: ".fingerprint|build|deps|incremental"
          path: ./target/debug/
          depth: 4

      - name: Print Release
        uses: jaywcjlove/github-action-folder-tree@main
        with:
          exclude: ".fingerprint|build|deps|incremental"
          path: ./target/release/
          depth: 4

#      - name: Export artifacts
#        uses: actions/upload-artifact@v2
#        with:
#          name: ${{ runner.os }}-${{ matrix.platform.cpu }}-${{ matrix.builder }}
