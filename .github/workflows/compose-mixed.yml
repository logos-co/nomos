name: Compose Mixed Workload

on:
  workflow_dispatch:

jobs:
  compose-mixed-workload:
    if: github.actor != 'nektos/act'
    runs-on:
      - self-hosted
      - mac-docker
    env:
      TMPDIR: ${{ github.workspace }}/.tmp
      NOMOS_TESTNET_PLATFORM: linux/amd64
      NOMOS_CIRCUITS_PLATFORM: linux-x86_64

    steps: &compose-steps
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare workspace tmpdir
        run: mkdir -p "$TMPDIR"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl docker.io clang llvm-dev libclang-dev pkg-config cmake libssl-dev
          if ! docker compose version >/dev/null 2>&1; then
            ARCH=$(uname -m)
            case "$ARCH" in
              arm64|aarch64) COMPOSE_URL="https://github.com/docker/compose/releases/download/v2.29.7/docker-compose-linux-aarch64" ;;
              *) COMPOSE_URL="https://github.com/docker/compose/releases/download/v2.29.7/docker-compose-linux-x86_64" ;;
            esac
            sudo install -d /usr/libexec/docker/cli-plugins
            sudo curl -sSL "$COMPOSE_URL" -o /usr/libexec/docker/cli-plugins/docker-compose
            sudo chmod +x /usr/libexec/docker/cli-plugins/docker-compose
          fi

      - name: Detect host architecture settings
        run: |
          ARCH=$(docker info -f '{{.Architecture}}' 2>/dev/null || uname -m)
          case "$ARCH" in
            arm64|aarch64)
              echo "NOMOS_TESTNET_PLATFORM=linux/arm64" >> "$GITHUB_ENV"
              echo "NOMOS_CIRCUITS_PLATFORM=linux-x86_64" >> "$GITHUB_ENV"
              echo "COMPOSE_CIRCUITS_PLATFORM=linux-aarch64" >> "$GITHUB_ENV"
              echo "NOMOS_CIRCUITS_REBUILD_RAPIDSNARK=1" >> "$GITHUB_ENV"
              if [ -d nomos-circuits-arm64 ]; then
                echo "CIRCUITS_OVERRIDE=nomos-circuits-arm64" >> "$GITHUB_ENV"
              fi
              ;;
            *)
              echo "NOMOS_TESTNET_PLATFORM=linux/amd64" >> "$GITHUB_ENV"
              echo "NOMOS_CIRCUITS_PLATFORM=linux-x86_64" >> "$GITHUB_ENV"
              echo "COMPOSE_CIRCUITS_PLATFORM=linux-x86_64" >> "$GITHUB_ENV"
              echo "NOMOS_CIRCUITS_REBUILD_RAPIDSNARK=0" >> "$GITHUB_ENV"
              ;;
          esac

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-target-compose-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-target-compose-

      - name: Install nomos circuits
        run: |
          CIRCUITS_DIR="${RUNNER_TEMP:-$TMPDIR}/nomos-circuits"
          chmod +x scripts/setup-nomos-circuits.sh
          export NOMOS_CIRCUITS_PLATFORM="${NOMOS_CIRCUITS_PLATFORM:-linux-x86_64}"
          export NOMOS_CIRCUITS_REBUILD_RAPIDSNARK="${NOMOS_CIRCUITS_REBUILD_RAPIDSNARK:-0}"
          scripts/setup-nomos-circuits.sh v0.2.0 "$CIRCUITS_DIR"
          echo "NOMOS_CIRCUITS=$CIRCUITS_DIR" >> $GITHUB_ENV

      - name: Build compose test image
        env:
          DOCKER_CLI_HINTS: "false"
        run: |
          BUILD_ARGS=""
          if [ -n "${CIRCUITS_OVERRIDE:-}" ]; then
            BUILD_ARGS="--build-arg CIRCUITS_OVERRIDE=${CIRCUITS_OVERRIDE}"
          fi
          docker build --platform "${NOMOS_TESTNET_PLATFORM:-linux/amd64}" \
            $BUILD_ARGS \
            -t nomos-testnet:local \
            -f testing-framework/runners/docker/runner.Dockerfile \
            .

      - name: Run compose mixed workload binary
        env:
          POL_PROOF_DEV_MODE: "true"
        run: |
          mkdir -p "$TMPDIR"
          if [ "${{ env.ACT }}" = "true" ]; then
            export COMPOSE_RUNNER_PRESERVE=1
          fi
          cargo run -p tests-workflows --all-features --bin compose_runner_ci

      - name: Collect compose logs
        if: failure()
        run: |
          mkdir -p ci-artifacts/compose
          docker ps -a --filter "name=nomos-compose-" --format '{{.ID}} {{.Names}} {{.Status}}' > ci-artifacts/compose/containers.txt || true
          for id in $(docker ps -a --filter "name=nomos-compose-" -q); do
            docker logs "$id" > "ci-artifacts/compose/${id}.log" 2>&1 || true
          done
          if compgen -G "tests/.tmp*/__logs.*" > /dev/null; then
            mkdir -p ci-artifacts/tests
            find tests -path "tests/.tmp*/__logs.*" -type d -print0 | while IFS= read -r -d '' dir; do
              tar -czf "ci-artifacts/tests/$(basename "$(dirname "$dir")")-$(basename "$dir").tgz" -C "$dir" .
            done
          fi

      - name: Upload compose artifacts
        if: failure() && env.ACT != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: compose-mixed-workload-logs
          path: ci-artifacts

      - name: Cleanup compose containers
        if: always()
        run: |
          ids=$(docker ps -a --filter "name=nomos-compose-" -q)
          if [ -n "$ids" ]; then
            docker rm -f $ids
          fi

  compose-mixed-workload-act:
    if: github.actor == 'nektos/act'
    runs-on: ubuntu-22.04
    env:
      TMPDIR: ${{ github.workspace }}/.tmp
      NOMOS_TESTNET_PLATFORM: linux/amd64
      NOMOS_CIRCUITS_PLATFORM: linux-x86_64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare workspace tmpdir
        run: mkdir -p "$TMPDIR"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl docker.io clang llvm-dev libclang-dev pkg-config cmake libssl-dev
          if ! docker compose version >/dev/null 2>&1; then
            ARCH=$(uname -m)
            case "$ARCH" in
              arm64|aarch64) COMPOSE_URL="https://github.com/docker/compose/releases/download/v2.29.7/docker-compose-linux-aarch64" ;;
              *) COMPOSE_URL="https://github.com/docker/compose/releases/download/v2.29.7/docker-compose-linux-x86_64" ;;
            esac
            sudo install -d /usr/libexec/docker/cli-plugins
            sudo curl -sSL "$COMPOSE_URL" -o /usr/libexec/docker/cli-plugins/docker-compose
            sudo chmod +x /usr/libexec/docker/cli-plugins/docker-compose
          fi

      - name: Detect host architecture settings
        run: |
          ARCH=$(docker info -f '{{.Architecture}}' 2>/dev/null || uname -m)
          case "$ARCH" in
            arm64|aarch64)
              echo "NOMOS_TESTNET_PLATFORM=linux/arm64" >> "$GITHUB_ENV"
              echo "NOMOS_CIRCUITS_PLATFORM=linux-x86_64" >> "$GITHUB_ENV"
              echo "COMPOSE_CIRCUITS_PLATFORM=linux-aarch64" >> "$GITHUB_ENV"
              echo "NOMOS_CIRCUITS_REBUILD_RAPIDSNARK=1" >> "$GITHUB_ENV"
              if [ -d nomos-circuits-arm64 ]; then
                echo "CIRCUITS_OVERRIDE=nomos-circuits-arm64" >> "$GITHUB_ENV"
              fi
              ;;
            *)
              echo "NOMOS_TESTNET_PLATFORM=linux/amd64" >> "$GITHUB_ENV"
              echo "NOMOS_CIRCUITS_PLATFORM=linux-x86_64" >> "$GITHUB_ENV"
              echo "COMPOSE_CIRCUITS_PLATFORM=linux-x86_64" >> "$GITHUB_ENV"
              echo "NOMOS_CIRCUITS_REBUILD_RAPIDSNARK=0" >> "$GITHUB_ENV"
              ;;
          esac

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-target-compose-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-target-compose-

      - name: Install nomos circuits
        run: |
          CIRCUITS_DIR="${RUNNER_TEMP:-$TMPDIR}/nomos-circuits"
          chmod +x scripts/setup-nomos-circuits.sh
          export NOMOS_CIRCUITS_PLATFORM="${NOMOS_CIRCUITS_PLATFORM:-linux-x86_64}"
          export NOMOS_CIRCUITS_REBUILD_RAPIDSNARK="${NOMOS_CIRCUITS_REBUILD_RAPIDSNARK:-0}"
          scripts/setup-nomos-circuits.sh v0.2.0 "$CIRCUITS_DIR"
          echo "NOMOS_CIRCUITS=$CIRCUITS_DIR" >> $GITHUB_ENV

      - name: Build compose test image
        env:
          DOCKER_CLI_HINTS: "false"
        run: |
          BUILD_ARGS=""
          if [ -n "${CIRCUITS_OVERRIDE:-}" ]; then
            BUILD_ARGS="--build-arg CIRCUITS_OVERRIDE=${CIRCUITS_OVERRIDE}"
          fi
          docker build --platform "${NOMOS_TESTNET_PLATFORM:-linux/amd64}" \
            $BUILD_ARGS \
            -t nomos-testnet:local \
            -f testing-framework/runners/docker/runner.Dockerfile \
            .

      - name: Run compose mixed workload binary
        env:
          POL_PROOF_DEV_MODE: "true"
        run: |
          mkdir -p "$TMPDIR"
          if [ "${{ env.ACT }}" = "true" ]; then
            export COMPOSE_RUNNER_PRESERVE=1
          fi
          cargo run -p tests-workflows --all-features --bin compose_runner_ci

      - name: Collect compose logs
        if: failure()
        run: |
          mkdir -p ci-artifacts/compose
          docker ps -a --filter "name=nomos-compose-" --format '{{.ID}} {{.Names}} {{.Status}}' > ci-artifacts/compose/containers.txt || true
          for id in $(docker ps -a --filter "name=nomos-compose-" -q); do
            docker logs "$id" > "ci-artifacts/compose/${id}.log" 2>&1 || true
          done
          if compgen -G "tests/.tmp*/__logs.*" > /dev/null; then
            mkdir -p ci-artifacts/tests
            find tests -path "tests/.tmp*/__logs.*" -type d -print0 | while IFS= read -r -d '' dir; do
              tar -czf "ci-artifacts/tests/$(basename "$(dirname "$dir")")-$(basename "$dir").tgz" -C "$dir" .
            done
          fi

      - name: Upload compose artifacts
        if: failure() && env.ACT != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: compose-mixed-workload-logs
          path: ci-artifacts

      - name: Cleanup compose containers
        if: always()
        run: |
          ids=$(docker ps -a --filter "name=nomos-compose-" -q)
          if [ -n "$ids" ]; then
            docker rm -f $ids
          fi
